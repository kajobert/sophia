<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sophia Chat</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; height: 100vh; margin: 0; background-color: #f4f4f9; }
        .tabs { display: flex; border-bottom: 2px solid #ccc; background-color: #fff; }
        .tab-button { padding: 10px 20px; cursor: pointer; border: none; background-color: transparent; font-size: 16px; }
        .tab-button.active { border-bottom: 2px solid #007bff; font-weight: bold; color: #007bff; }
        .tab-content { display: none; flex-grow: 1; padding: 15px; overflow-y: auto; }
        .tab-content.active { display: flex; flex-direction: column; }
        #chat-container { flex-grow: 1; display: flex; flex-direction: column; }
        #chat-box { flex-grow: 1; overflow-y: auto; padding: 10px; border: 1px solid #ccc; margin-bottom: 10px; background-color: #fff; border-radius: 5px; }
        #input-area { display: flex; }
        #message-input { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        button { padding: 10px 15px; border: none; background-color: #007bff; color: white; border-radius: 5px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        .user-message, .assistant-message, .system-message { margin: 5px 0; }
        .message-bubble { display: inline-block; padding: 8px 12px; border-radius: 15px; max-width: 80%; }
        .user-message { text-align: right; }
        .user-message .message-bubble { background-color: #007bff; color: white; }
        .assistant-message .message-bubble { background-color: #e9e9eb; color: #333; }
        .system-message { text-align: center; font-style: italic; color: #888; }
        #help-content { line-height: 1.6; }
    </style>
</head>
<body>

    <div class="tabs">
        <button class="tab-button active" onclick="openTab('chat')">Chat</button>
        <button class="tab-button" onclick="openTab('help')">Nápověda</button>
    </div>

    <div id="chat" class="tab-content active">
        <div id="chat-container">
            <div id="chat-box"></div>
            <div id="input-area">
                <input type="text" id="message-input" placeholder="Napište zprávu Sophii...">
                <button onclick="sendMessage()">Odeslat</button>
            </div>
        </div>
    </div>

    <div id="help" class="tab-content">
        <div id="help-content">
            <p>Načítání dokumentace...</p>
        </div>
    </div>

    <script>
        const chatBox = document.getElementById('chat-box');
        const messageInput = document.getElementById('message-input');

        let sessionId = localStorage.getItem('sophia-session-id') || `session-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
        localStorage.setItem('sophia-session-id', sessionId);

        let ws;
        let reconnectInterval = 1000; // Start with 1 second

        function connect() {
            ws = new WebSocket(`ws://localhost:8180/ws/${sessionId}`);

            ws.onopen = () => {
                console.log('WebSocket connection established.');
                addMessage('Připojeno. Jsem online a připravena.', 'system-message');
                reconnectInterval = 1000; // Reset interval on successful connection
            };

            ws.onmessage = (event) => {
                try {
                    console.log('Received message:', event.data);
                    addMessage(event.data, 'assistant-message');
                } catch (error) {
                    console.error('Error processing received message:', error);
                    addMessage('Došlo k chybě při zobrazení odpovědi.', 'system-message');
                }
            };

            ws.onerror = (error) => {
                console.error('WebSocket Error:', error);
            };

            ws.onclose = (event) => {
                console.log('WebSocket connection closed.', event.reason);
                addMessage('Spojení bylo ukončeno. Pokouším se znovu připojit...', 'system-message');
                setTimeout(connect, reconnectInterval);
                // Exponential backoff can be added here if needed
                // reconnectInterval = Math.min(reconnectInterval * 2, 30000);
            };
        }

        connect();

        function sendMessage() {
            if (messageInput.value.trim() !== '' && ws && ws.readyState === WebSocket.OPEN) {
                ws.send(messageInput.value);
                addMessage(messageInput.value, 'user-message');
                messageInput.value = '';
            } else {
                console.log('Cannot send message. WebSocket is not open.');
            }
        }

        function addMessage(message, className) {
            const messageElement = document.createElement('div');
            messageElement.className = className;
            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            bubble.textContent = message;
            messageElement.appendChild(bubble);
            chatBox.appendChild(messageElement);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        messageInput.addEventListener('keyup', (event) => { if (event.key === 'Enter') sendMessage(); });

        let helpContentLoaded = false;
        function openTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tc => tc.style.display = 'none');
            document.querySelectorAll('.tab-button').forEach(tb => tb.classList.remove('active'));
            document.getElementById(tabName).style.display = 'flex';
            event.currentTarget.classList.add('active');
            if (tabName === 'help' && !helpContentLoaded) {
                loadHelpContent();
            }
        }

        async function loadHelpContent() {
            try {
                const response = await fetch('/docs/sophia_chat_guide.md');
                if (!response.ok) throw new Error('Failed to fetch');
                const markdownText = await response.text();
                document.getElementById('help-content').innerHTML = marked.parse(markdownText);
                helpContentLoaded = true;
            } catch (error) {
                console.error('Error loading help content:', error);
                document.getElementById('help-content').innerHTML = '<p>Nepodařilo se načíst dokumentaci.</p>';
            }
        }
    </script>
</body>
</html>
