<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sophia Chat</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* CSS remains the same as before */
        body { font-family: sans-serif; display: flex; flex-direction: column; height: 100vh; margin: 0; background-color: #f4f4f9; }
        .tabs { display: flex; border-bottom: 2px solid #ccc; background-color: #fff; }
        .tab-button { padding: 10px 20px; cursor: pointer; border: none; background-color: transparent; font-size: 16px; }
        .tab-button.active { border-bottom: 2px solid #007bff; font-weight: bold; color: #007bff; }
        .tab-content { display: none; flex-grow: 1; padding: 15px; overflow-y: auto; }
        .tab-content.active { display: flex; flex-direction: column; }
        #chat-container { flex-grow: 1; display: flex; flex-direction: column; }
        #chat-box { flex-grow: 1; overflow-y: auto; padding: 10px; border: 1px solid #ccc; margin-bottom: 10px; background-color: #fff; border-radius: 5px; }
        #input-area { display: flex; }
        #message-input { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        button { padding: 10px 15px; border: none; background-color: #007bff; color: white; border-radius: 5px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        .user-message, .assistant-message, .system-message { margin: 5px 0; }
        .message-bubble { display: inline-block; padding: 8px 12px; border-radius: 15px; max-width: 80%; }
        .user-message { text-align: right; }
        .user-message .message-bubble { background-color: #007bff; color: white; }
        .assistant-message .message-bubble { background-color: #e9e9eb; color: #333; }
        .system-message { text-align: center; font-style: italic; color: #888; }
        #help-content { line-height: 1.6; }
    </style>
</head>
<body>
    <!-- HTML structure remains the same -->
    <div class="tabs">
        <button class="tab-button active" onclick="openTab('chat')">Chat</button>
        <button class="tab-button" onclick="openTab('help')">Nápověda</button>
    </div>
    <div id="chat" class="tab-content active"><div id="chat-container">...</div></div>
    <div id="help" class="tab-content"><div id="help-content">...</div></div>

    <script>
        const chatBox = document.getElementById('chat-box');
        const messageInput = document.getElementById('message-input');

        let sessionId = localStorage.getItem('sophia-session-id') || `session-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
        localStorage.setItem('sophia-session-id', sessionId);

        let ws;

        function connect() {
            // Use the port you configured (e.g., 8081 if you changed it)
            ws = new WebSocket(`ws://localhost:8080/ws/${sessionId}`);

            ws.onopen = () => {
                console.log('WebSocket connection established.');
                addMessage('Připojeno. Jsem online a připravena.', 'system-message');
            };

            ws.onmessage = (event) => {
                // **THE FIX (Scenario 2):** Wrap message handling in a try...catch block.
                try {
                    console.log('Received message:', event.data);
                    addMessage(event.data, 'assistant-message');
                } catch (error) {
                    console.error('Error processing received message:', error);
                    addMessage('Došlo k chybě při zobrazení odpovědi.', 'system-message');
                }
            };

            ws.onerror = (error) => {
                console.error('WebSocket Error:', error);
                addMessage('Chyba spojení se serverem.', 'system-message');
            };

            ws.onclose = (event) => {
                console.log('WebSocket connection closed.', event.reason);
                addMessage('Spojení bylo ukončeno. Pokouším se znovu připojit...', 'system-message');
                // **THE FIX (Scenario 1):** Robust reconnection logic.
                // Wait 1 second before trying to reconnect to avoid spamming.
                setTimeout(connect, 1000);
            };
        }

        // Initial connection
        connect();

        function sendMessage() {
            const message = messageInput.value;
            if (message.trim() !== '' && ws.readyState === WebSocket.OPEN) {
                ws.send(message);
                addMessage(message, 'user-message');
                messageInput.value = '';
            } else {
                addMessage('Nelze odeslat zprávu. Spojení není aktivní.', 'system-message');
            }
        }

        function addMessage(message, className) {
            // This function is the same as before
            const messageElement = document.createElement('div');
            messageElement.className = className;
            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            bubble.textContent = message;
            messageElement.appendChild(bubble);
            chatBox.appendChild(messageElement);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // Event listener for Enter key is the same
        messageInput.addEventListener('keyup', (event) => { if (event.key === 'Enter') sendMessage(); });

        // Tab and Help Documentation Logic is the same
        let helpContentLoaded = false;
        function openTab(tabName) { /* ... same as before ... */ }
        async function loadHelpContent() { /* ... same as before ... */ }
    </script>
</body>
</html>
