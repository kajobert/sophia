<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sophia Chat</title>
    <!-- Include the Marked.js library from a CDN -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; height: 100vh; margin: 0; background-color: #f4f4f9; }
        .tabs { display: flex; border-bottom: 2px solid #ccc; background-color: #fff; }
        .tab-button { padding: 10px 20px; cursor: pointer; border: none; background-color: transparent; font-size: 16px; }
        .tab-button.active { border-bottom: 2px solid #007bff; font-weight: bold; color: #007bff; }
        .tab-content { display: none; flex-grow: 1; padding: 15px; overflow-y: auto; }
        .tab-content.active { display: flex; flex-direction: column; }
        #chat-container { flex-grow: 1; display: flex; flex-direction: column; }
        #chat-box { flex-grow: 1; overflow-y: auto; padding: 10px; border: 1px solid #ccc; margin-bottom: 10px; background-color: #fff; border-radius: 5px; }
        #input-area { display: flex; }
        #message-input { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        button { padding: 10px 15px; border: none; background-color: #007bff; color: white; border-radius: 5px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        .user-message { text-align: right; margin: 5px 0; }
        .assistant-message { text-align: left; margin: 5px 0; }
        .message-bubble { display: inline-block; padding: 8px 12px; border-radius: 15px; max-width: 80%; }
        .user-message .message-bubble { background-color: #007bff; color: white; }
        .assistant-message .message-bubble { background-color: #e9e9eb; color: #333; }
        #help-content { line-height: 1.6; }
    </style>
</head>
<body>

    <div class="tabs">
        <button class="tab-button active" onclick="openTab('chat')">Chat</button>
        <button class="tab-button" onclick="openTab('help')">Nápověda</button>
    </div>

    <div id="chat" class="tab-content active">
        <div id="chat-container">
            <div id="chat-box"></div>
            <div id="input-area">
                <input type="text" id="message-input" placeholder="Napište zprávu Sophii...">
                <button onclick="sendMessage()">Odeslat</button>
            </div>
        </div>
    </div>

    <div id="help" class="tab-content">
        <div id="help-content">
            <!-- Documentation will be loaded here -->
            <p>Načítání dokumentace...</p>
        </div>
    </div>

    <script>
        const chatBox = document.getElementById('chat-box');
        const messageInput = document.getElementById('message-input');

        let sessionId = localStorage.getItem('sophia-session-id');
        if (!sessionId) {
            sessionId = 'session-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('sophia-session-id', sessionId);
        }

        // Use the port you configured (e.g., 8081 if you changed it)
        const ws = new WebSocket(`ws://localhost:8080/ws/${sessionId}`);

        ws.onopen = () => {
            console.log('Connected to WebSocket server.');
            addMessage('Jsem online. Jak vám mohu pomoci?', 'assistant-message');
        };

        ws.onmessage = (event) => {
            addMessage(event.data, 'assistant-message');
        };

        ws.onerror = (error) => {
            console.error('WebSocket Error:', error);
            addMessage('Chyba připojení k serveru.', 'system-message');
        };

        ws.onclose = () => {
            console.log('Disconnected from WebSocket server.');
        };

        function sendMessage() {
            const message = messageInput.value;
            if (message.trim() !== '') {
                ws.send(message);
                addMessage(message, 'user-message');
                messageInput.value = '';
            }
        }

        function addMessage(message, className) {
            const messageElement = document.createElement('div');
            messageElement.className = className;

            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            bubble.textContent = message;

            messageElement.appendChild(bubble);
            chatBox.appendChild(messageElement);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        messageInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });

        // --- Tab and Help Documentation Logic ---
        let helpContentLoaded = false;

        function openTab(tabName) {
            const tabContents = document.getElementsByClassName('tab-content');
            for (let i = 0; i < tabContents.length; i++) {
                tabContents[i].style.display = "none";
            }

            const tabButtons = document.getElementsByClassName('tab-button');
            for (let i = 0; i < tabButtons.length; i++) {
                tabButtons[i].className = tabButtons[i].className.replace(" active", "");
            }

            document.getElementById(tabName).style.display = "flex";
            event.currentTarget.className += " active";

            if (tabName === 'help' && !helpContentLoaded) {
                loadHelpContent();
            }
        }

        async function loadHelpContent() {
            try {
                // This path now works because FastAPI serves the 'docs' directory at the '/docs' endpoint.
                const response = await fetch('/docs/sophia_chat_guide.md');
                if (!response.ok) {
                    throw new Error(`Failed to fetch documentation: ${response.statusText}`);
                }
                const markdownText = await response.text();
                const helpContainer = document.getElementById('help-content');
                // Use Marked.js to parse the markdown text into HTML
                helpContainer.innerHTML = marked.parse(markdownText);
                helpContentLoaded = true;
            } catch (error) {
                console.error('Error loading help content:', error);
                document.getElementById('help-content').innerHTML = '<p>Nepodařilo se načíst dokumentaci. Zkuste to prosím znovu později.</p>';
            }
        }
    </script>
</body>
</html>
